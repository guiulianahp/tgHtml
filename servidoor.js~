
var app=require('express')();
var http = require('http').Server(app);
var io = require('socket.io')(http);
var longitudes=[];
var latitudes=[];
var estados=[];
var num=0;

	var pg = require('pg');
	var conString = "postgres://guiuliana:123456@localhost/SEI_VC";
	var client = new pg.Client(conString);
	client.connect();
	var query = client.query("SELECT estado, longitud, latitud FROM zona");

	var a = query.on('row', function(row) {
	  	num = num+1;
		estados.push(row.estado);
		longitudes.push(row.longitud);
		latitudes.push(row.latitud);
		});
        
	app.engine('.html', require('ejs').__express);
	
	app.use(app.static(path.join(__dirname, 'public')));
	
	app.set('views', __dirname + '/views');
	app.set('view engine', 'html');
        
	app.get('/', function(req, res){
	res.render('canvas', {
	estado: estados,
	longitud:longitudes,
	latitud:latitudes,
	num : num
	});
	});
var cadena="";
var actualizacion=[];
io.sockets.on('connection', function (socket) {
	client.query('LISTEN "watchers"');
	client.on('notification', function(data) {
	    cadena=data.payload;

	    estado = data.payload[4];
	    latitud = cadena.slice(5,14);
	    longitud = cadena.slice(15,23);
	    actualizacion.push(estado);
	    actualizacion.push(latitud);
	    actualizacion.push(longitud);
	    
	    socket.emit('update',{'message':actualizacion});
		actualizacion = [];
	});
	    
			
    	});
        
    	





http.listen(3000, function(){
console.log("Express is running on port *:3000");
});
